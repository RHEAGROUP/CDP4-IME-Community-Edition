image: Visual Studio 2019
environment:
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  PROJECT_MAIN:   'CDP4-CE'
  TEST_RESULT:    'TestResult.xml'
  TEST_COVERAGE:  'CoverResults.xml'
  TEST_LOG:       'TestResults'

for:
# configuration for "master" branch, build in Release mode
-
  branches:
    only:
      - master
  configuration: Release
# configuration for "development" branch, build in Debug mode
-
  branches:
    only:
      - development
  configuration: Debug
# "fall back" configuration for all other branches
# no "branches" section defined
configuration: Debug
before_build:
  - cmd: nuget install NUnit.Console -Version 3.11.1 -OutputDirectory testrunner
  - cmd: nuget install NUnit.Runners -Version 3.11.1 -OutputDirectory testrunner
  - cmd: nuget sources add -name devexpress -source %DEVEXPRESS_API%
  - cmd: nuget restore -verbosity quiet
  - cmd: choco install opencover.portable
  - cmd: choco install codecov

build:
  project: '%PROJECT_MAIN%.sln'
  verbosity: minimal

test_script:
    - >
      OpenCover.Console.exe
      -log:Error
      -register
      -target:".\testrunner\NUnit.ConsoleRunner.3.11.1\tools\nunit3-console.exe"
      -targetargs:"cdp4ime-tests.nunit --where=""cat!=WebServicesDependent && cat!=AppVeyorExclusion && cat!=OfficeDependent"""
      -returntargetcode
      -hideskipped:All
      -output:"%TEST_COVERAGE%"
      -filter:"+[CDP4Budget*]* +[CDP4AddinCE*]* +[CDP4Composition*]* +[CDP4BasicRdl*]* +[CDP4ShellDialogs*]* +[CDP4CommonView*]* +[CDP4BuiltInRules*]* +[CDP4Dashboard*]* +[CDP4IME*]* +[CDP4LogInfo*]* +[CDP4OfficeInfrastructure*]* +[CDP4ObjectBrowser*]* +[CDP4ParameterSheetGenerator*]* +[CDP4PropertyGrid*]* +[CDP4Scripting*]* +[CDP4RelationshipEditor*]* +[CDP4SiteDirectory*]* +[CDP4SystemsToolKit*]* +[CDP4ProductTree*]* +[CDP4EngineeringModel*]* +[CDP4RelationshipMatrix*]* -[*.Tests*]* -[*.Views]*"
after_test:
    - codecov -f "%TEST_COVERAGE%" -t %CODECOV_TOKEN%
    - xcopy /q /Y /I "%TEST_RESULT%" "%TEST_LOG%\"
    - xcopy /q /Y /I "%TEST_COVERAGE%" "%TEST_LOG%\"
artifacts:
    - path: '%TEST_LOG%'
notifications:
  - provider: Email
    to:
      - cdp_devs@rheagroup.com
